<!DOCTYPE html>
<html>

<% include ../layout %>

<script>
  
 </script>

<body>
  <!-- Sidenav -->
  <% include ../partials/sidebar %>
  <!-- Main content -->
  <div class="main-content">
    <!-- Top navbar -->
    <% include ../partials/navbar %>
    <!-- Header -->
    <% include ../partials/header %>
    <!-- Page content -->
    <div class="container-fluid mt--7 pt-md-6">
      <div class="row">
        <div class="col-lg-7 mb-5 mb-xl-0">
          <div class="card bg-gradient-default shadow">
              <% include ../partials/message %>
            <div class="card-header bg-transparent">
              <div class="row align-items-center">
                  <ul class="navbar-nav align-items-center d-none d-md-flex">
                      <li class="nav-item dropdown">
                        <a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                          aria-expanded="false">
                          <div class="media align-items-center">                
                            <div class="media-body ml-2 d-none d-lg-block">
                              <span class="mb-0 text-sm font-weight-bold">Legenda do Calendário</span>
                            </div>
                          </div>
                        </a>
                        <% include ../partials/legendas %>
                      </li>
                    </ul> 
                <div class="col">
                  <ul class="nav nav-pills justify-content-end">
                    
                      <li class="nav-item" data-toggle="chart" data-target="#chart-sales">
                      
                      <a href="#register" class="nav-link py-1 px-1 deactive" data-toggle="modal">
                        <span class="d-none d-md-block">Nova Consulta</span>
                      </a>
                    </li>
                    <% if (user.NivelPermissaoId == 1  || user.NivelPermissaoId == 2) { %>
                      <li class="nav-item" data-toggle="chart" data-target="#chart-sales">
                        <a href="/dashboard" class="nav-link py-1 px-1 active">
                            <span class="d-none d-md-block">Ver Consultas</span>
                        </a>
                      </li>
                      <li class="nav-item" data-toggle="chart" data-target="#chart-sales">
                        <a href="/schedules" class="nav-link py-1 px-1 active">
                            <span class="d-none d-md-block">Ver Agendamentos</span>
                        </a>
                      </li>
                    <% } %>
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="card-body">
              <div style="font-size: 14px" id='calendarDashboard'></div>


            </div>
            
          </div>
         
        </div>
        <div class="col-xl-5" id="viewConsultDashboard">
          <div class="card shadow">
            <div class="card-header bg-transparent">
              <div class="row align-items-center">  
                <div class="col">
                  <div class="form-group">
                          <label class="form-control-label">Consultas</label>
                          <% if (user.NivelPermissaoId == 1 || user.NivelPermissaoId == 2) {%>
                          <a style="color: black; float: right;"class="btn btn-sm btn-outline-primary" >Você tem <%= countSchedules[0].typeSchedule %> Agendamento(os)</a>
                         <% }%>
                  </div>  
                  <button class="btn btn-primary primary"
                  id="allConsultDays">Hoje</button>
                  <a class="btn btn-primary primary"
                    href="">Proximas</a>
                </div>

              </div>
            </div>
            <div class="card-body" >              
              <div class="chart">
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">Paciente</th>
                      <th scope="col">Data</th>
                      <th scope="col">Hora</th>
                    </tr>
                  </thead>
                  <tbody id="table-day"> 
                   <!-- Criando tabela pelo ajax -->
                    </tbody>
                </table>
                
                <canvas id="chart-orders" class="chart-canvas"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-5">
        <div class="col-xl-12 mb-5 mb-xl-0">
          <div class="card shadow">
            <div class="card-header border-0">
              <div class="row align-items-center">
                <div class="col">
                  <h3 class="mb-0">Consultas Marcadas</h3>
                </div>
                
                <div class="col text-right">
                    <a class="btn btn-sm btn-primary" id="allConsultNext">Proximas Consultas</a>
                    <a class="btn btn-sm btn-primary" id="completeConsultDays">Marcadas para Hoje</a>
                  <a href="/consultation" class="btn btn-sm btn-primary">Ver Todas</a>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <!-- Projects table -->
              <table class="table table-striped align-items-center table-md">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Tipo</th>
                    <th scope="col">Nome</th>
                    <th scope="col">Telefone</th>
                    <th scope="col">Horario</th>
                    <th scope="col">Estagiário</th>
                    <th scope="col">Usuario</th>

                  </tr>
                </thead>
                <tbody id="table-complete"> 
                     
                  </tbody>
              </table>
            </div>
          </div>
        </div>

    <% include ../partials/schedulesModal %>  
      </div>
      <!-- Footer -->
      <% include ../partials/footer %>
    </div>

  </div>
  <!-- Include scripts -->
  <% include ../partials/scripts %>

</body>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendarDashboard');

        var calendarDashboard = new FullCalendar.Calendar(calendarEl, {
            locale: 'pt-br',
            plugins: ['interaction', 'dayGrid', 'moment'],
            //defaultDate: '2019-04-12',
            editable: true,
            
            eventLimit: true, // allow "more" link when too many events
            events: [
            '<% for (var i = 0; i < consultation.length; i++) {%>',
                '<% if (consultation[i].consultTraineeId != null) { %>',
                {
                    id: '<%= consultation[i].id  %>',
                    title: '<%= consultation[i].consultPatient.name %>',
                    start: '<%= moment(consultation[i].dateStart).format()  %>',
                    end: '<%= moment(consultation[i].dateEnd).add(4, "hours").format()  %>',
                    color: '<%= consultation[i].color  %>',
                    extendedProps: {
                        trainee: '<%= consultation[i].consultTraineeId %>',
                        description: '<%= consultation[i].description  %>',
                        typeSchedule: '<%= consultation[i].typeSchedule  %>',
                        patientId: '<%= consultation[i].consultPatientId %>',
                        typeProcedure: '<%= consultation[i].typeProcedureId %>',
                    },
                    textColor: '#fff',
                },
                '<% } else { %>',
                {
                    id: '<%= consultation[i].id  %>',
                    title: '<%= consultation[i].consultPatient.name %>',
                    start: '<%= moment(consultation[i].dateStart).format()  %>',
                    end: '<%= moment(consultation[i].dateEnd).add(4, "hours").format()  %>',
                    color: '<%= consultation[i].color  %>',
                    extendedProps: {
                        description: '<%= consultation[i].description  %>',
                        typeSchedule: '<%= consultation[i].typeSchedule  %>',
                        patientId: '<%= consultation[i].consultPatientId %>',
                    },
                    textColor: '#fff',
                },
                '<% } %>',
                '<% } %>',

            ],

            eventClick: function (info) {
              info.jsEvent.preventDefault();
                if (info.event.extendedProps.typeSchedule == 1) {
                  var dt = moment(info.event.start);

                    $('#viewConsult #id').val(info.event.id);
                    $('#viewConsult #patient').val(info.event.title);
                    $('#viewConsult #dateStart').val(dt.format('YYYY-MM-DD'));
                    $('#viewConsult #timeStart').val(dt.format('HH:mm'));
                    $('#viewConsult #traineeId').val(info.event.extendedProps.trainee);
                    $('#viewConsult #scheduleTypeConsult').val(info.event.extendedProps.typeSchedule);
                    $('#viewConsult #description').val(info.event.extendedProps.description);
                    $('#viewConsult #typeProcedure').val(info.event.extendedProps.typeProcedure);

                    $('#viewConsult').modal('show');

                } else if (info.event.extendedProps.typeSchedule == 2) {
                    var dt = moment(info.event.start);

                    $('#viewConsultPatient #id').val(info.event.id);
                    $('#viewConsultPatient #patientIdHidden').val(info.event.extendedProps.patientId);
                    $('#viewConsultPatient #patient').val(info.event.title);
                    $('#viewConsultPatient #dateStart').val(dt.format('YYYY-MM-DD'));
                    $('#viewConsultPatient #timeStart').val(dt.format('HH:mm'));
                    $('#viewConsultPatient #typeScheduleSchedules').val(info.event.extendedProps.typeSchedule);
                    $('#viewConsultPatient').modal('show');

                }
            },

            selectable: true,
            select: function (info) {
              var dt = moment(info.start);
                $('#register #dateStart').val(dt.format('YYYY-MM-DD'));
                $('#register #timeStart').val(dt.format('HH:mm'));

                $('#viewConsultDashboard #dateConsult').val(dt.format('YYYY-MM-DDTHH:mm'));
            },
        
        });

        calendarDashboard.render();
    });
</script>

</html>